---
# TODO: set draft: True  # this gets removed by the preprocessor
format: html
code-fold: true
editor: source
params: 
  # cruise_id: WS21093
  cruise_id: WS21093  # NOTE: this must = WS21093 for prerender to work
---
# WS21093

```{R}
#| code-summary: setup
if (!nzchar(system.file(package = "librarian"))) {
  install.packages("librarian")
}

librarian::shelf(
  quiet = TRUE,
  readr, here, fs, ggplot2, glue, "jiho/castr", dplyr, oce, patchwork, purrr, tidyr
)
```

```{R}
source(here::here("R/load_cruise_ctds.R"))
cruise_df <- load_cruise_ctds(params$cruise_id)
```




```{R}
#| code-summary: plot across all stations
library(plotly)

p <- ggplot(cruise_df, aes(x = time, y = sea_water_temperature, color = station)) +
  geom_point(size = 1.8) +
  labs(x = "Time", y = "Temperature (°C)",
       title = "Temperature over Time by Station") +
  theme_minimal()

ggplotly(p)

```

```{R}
#| code-summary: interactive map of stations
library(leaflet)

# Get one location per station (taking the first non-NA lat/lon for each station)
station_locations <- cruise_df %>%
  group_by(station) %>%
  summarise(
    latitude = first(na.omit(latitude)),
    longitude = first(na.omit(longitude)),
    n_observations = n(),
    mean_temp = mean(sea_water_temperature, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(!is.na(latitude) & !is.na(longitude))

# Create color palette based on temperature
pal <- colorNumeric(
  palette = "RdYlBu",
  domain = station_locations$mean_temp,
  reverse = TRUE  # Red for warm, blue for cold
)

# Create interactive map
leaflet(station_locations) %>%
  addTiles() %>%  # Add default OpenStreetMap tiles
  addCircleMarkers(
    lng = ~longitude,
    lat = ~latitude,
    radius = 8,
    color = "#333333",
    fillColor = ~pal(mean_temp),
    fillOpacity = 0.8,
    weight = 1,
    popup = ~paste0(
      "<strong>Station: </strong>", station, "<br>",
      "<strong>Observations: </strong>", n_observations, "<br>",
      "<strong>Mean Temp: </strong>", round(mean_temp, 2), " °C<br>",
      "<strong>Lat: </strong>", round(latitude, 4), "<br>",
      "<strong>Lon: </strong>", round(longitude, 4)
    ),
    label = ~station
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal,
    values = ~mean_temp,
    title = "Mean Temperature (°C)",
    opacity = 0.8
  ) %>%
  addScaleBar(position = "bottomleft")

```





