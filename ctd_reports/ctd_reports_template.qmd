---
format: html
code-fold: true
editor: source
params: 
  cast_id: WS16074_WS16074_WS16074stn2  # NOTE: this must = WS16074_WS16074_WS16074stn2 for prerender to work
---

```{R}
#| code-summary: setup
if (!nzchar(system.file(package = "librarian"))) {
  install.packages("librarian")
}

librarian::shelf(
  quiet = TRUE,
  readr, here, fs, ggplot2, glue, "jiho/castr", dplyr, oce, patchwork, purrr, tidyr
)

# get cruise ID from splitting cast_id by _
cruise_id <- sub("_.*", "", params$cast_id)
# get station ID from filename
station_id <- sub(glue::glue(".*{cruise_id}"), "", fs::path_file(basename(params$cast_id)))

```

```{R}
source(here::here("R/ctd_load_from_csv.R"))
cast <- ctd_load_from_csv(here::here(glue::glue(
  "data/01_raw/ctd/{cruise_id}/{params$cast_id}.csv"
)))


```

## before cleaning
```{R}

print(glue("=== station: {cast@metadata$station[1]}"))
print(glue("# scans: {length(cast@data$scan)}"))
plotScan(cast)
```

## after cleaning
```{R}
#| code-summary: clean & export
tryCatch({

  trimmed_cast <- ctdTrim(cast)
  decimated_cast <- ctdDecimate(trimmed_cast, p = 0.5)

  # plotting can cause the xlim failure
  plotScan(decimated_cast)

  # === export ===
  cast_df <- as.data.frame(decimated_cast@data)

  # Add metadata
  cast_df <- mutate(
    cast_df,
    station = station_id,
    cruise_id = cruise_id
  )

  # drop NA rows left by cleaning
  cast_df <- subset(cast_df, !is.na(scan))

  # create folder if doesn't exist
  clean_data_loc <- here::here("data/02_clean")
  try(fs::dir_create(clean_data_loc))

  # save ctd to .csv
  write.csv(cast_df, glue("{clean_data_loc}/{params$cast_id}.csv"))

}, error = function(e) {

  cat("\n=== CTD PROCESSING ERROR ===\n")
  cat("Cast ID:", params$cast_id, "\n")
  cat("Error message:\n", conditionMessage(e), "\n\n")

  # Safely inspect objects that might or might not exist when the error happened
  if (exists("decimated_cast")) {
    df <- try(as.data.frame(decimated_cast@data), silent = TRUE)
    if (!inherits(df, "try-error")) {

      cat("Dataframe columns:\n")
      print(names(df))

      cat("\nSummary of key columns (scan, pressure, temperature, salinity if present):\n")
      known_cols <- intersect(c("scan", "pressure", "temp", "temperature", "salinity", "conductivity"), names(df))
      print(summary(df[known_cols], digits = 3))

      cat("\nHead of dataframe:\n")
      print(head(df))
    } else {
      cat("Could not extract dataframe from decimated_cast.\n")
    }
  } else {
    cat("decimated_cast was never created before the error.\n")
  }

  cat("\n=== END ERROR DEBUG INFO ===\n\n")
})

```
